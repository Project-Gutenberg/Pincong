<!doctype html><html lang=zh-cn><head>
<meta charset=utf-8>
<title>SS/SSR做负载均衡的两种方法-荒岛</title>
<meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1">
<meta name=description content=" 负载均衡最大的作用就是0宕机，可以做到宕机秒切换。SS/SSR的PC客户端都有负载均衡的功能，而且还可以根据延迟进行负载均衡，但iOS端就有点蛋疼了，一直使用PotatsoLite的我有时候真的挺需要这个功能的。
这里介绍两种方法，第一种用HAProxy，第二种用Nginx。个人推荐用Nginx，因为HAProxy不支持UDP，如果是用来玩游戏，那就有点蛋疼了。而且有时候也确实需要用到UDP。
这里我准备了3台机器，一台用来做负载均衡服务器，另外两台跑SSR服务，实现功能：两台SSR机器如有某一台挂了，本地客户端可以自动切换并连接到正常运行的那一台。
这里补充一下，LEDE软路由是有这个HAProxy功能的，而且做SS/SSR负载均衡的话，建议HAProxy是搭建在本地，因为如果你搭建在服务器上，你跑HAProxy的那台机器挂了也就失去了负载均衡的意义。
两个前提条件：
1：所有的SS/SSR密码必须一致。
2：所有的SS/SSR加密方式必须一致。如果是SSR，那么协议/混淆也必须一致。
先安装：
yum -y install haproxy
将默认的配置文件做一个备份：
mv /etc/haproxy/haproxy.cfg /etc/haproxy/haproxy.cfg.bak
新建一个配置文件：
nano /etc/haproxy/haproxy.cfg
写入下面的配置：
global chroot /var/lib/haproxy pidfile /var/run/haproxy.pid user haproxy group haproxy
defaults mode tcp #服务器默认的工作模式 balance roundrobin #服务器默认使用的均衡模式 retries 3 #三次连接失败表示服务器不可用 maxconn 5000 #最大连接数 timeout connect 500ms #连接超时 timeout client 3s #客户端超时 timeout server 3s #服务器超时 ">
<meta name=generator content="Hugo 0.91.2">
<link rel=stylesheet href=../../plugins/bootstrap/bootstrap.min.css>
<link rel=stylesheet href=../../plugins/themify-icons/themify-icons.css>
<link rel=stylesheet href=https://project-gutenberg.github.io/Pincong/scss/style.min.css media=screen>
<link rel="shortcut icon" href=https://project-gutenberg.github.io/Pincong/images/favicon.png type=image/x-icon>
<link rel=icon href=https://project-gutenberg.github.io/Pincong/images/favicon.png type=image/x-icon>
<meta name=twitter:card content="summary_large_image">
<meta name=og:title content=" SS/SSR做负载均衡的两种方法-荒岛 ">
<meta name=og:description content=" 负载均衡最大的作用就是0宕机，可以做到宕机秒切换。SS/SSR的PC客户端都有负载均衡的功能，而且还可以根据延迟进行负载均衡，但iOS端就有点蛋疼了，一直使用PotatsoLite的我有时候真的挺需要这个功能的。
这里介绍两种方法，第一种用HAProxy，第二种用Nginx。个人推荐用Nginx，因为HAProxy不支持UDP，如果是用来玩游戏，那就有点蛋疼了。而且有时候也确实需要用到UDP。
这里我准备了3台机器，一台用来做负载均衡服务器，另外两台跑SSR服务，实现功能：两台SSR机器如有某一台挂了，本地客户端可以自动切换并连接到正常运行的那一台。
这里补充一下，LEDE软路由是有这个HAProxy功能的，而且做SS/SSR负载均衡的话，建议HAProxy是搭建在本地，因为如果你搭建在服务器上，你跑HAProxy的那台机器挂了也就失去了负载均衡的意义。
两个前提条件：
1：所有的SS/SSR密码必须一致。
2：所有的SS/SSR加密方式必须一致。如果是SSR，那么协议/混淆也必须一致。
先安装：
yum -y install haproxy
将默认的配置文件做一个备份：
mv /etc/haproxy/haproxy.cfg /etc/haproxy/haproxy.cfg.bak
新建一个配置文件：
nano /etc/haproxy/haproxy.cfg
写入下面的配置：
global chroot /var/lib/haproxy pidfile /var/run/haproxy.pid user haproxy group haproxy
defaults mode tcp #服务器默认的工作模式 balance roundrobin #服务器默认使用的均衡模式 retries 3 #三次连接失败表示服务器不可用 maxconn 5000 #最大连接数 timeout connect 500ms #连接超时 timeout client 3s #客户端超时 timeout server 3s #服务器超时 ">
<meta name=og:image content="https://project-gutenberg.github.io/Pincong//images/card/12.jpg">
<script data-ad-client=ca-pub-6074407261372769 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-06HJ1E5XNH"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-06HJ1E5XNH')</script>
</head>
<body>
<header class="fixed-top navigation">
<div class=container>
<nav class="navbar navbar-expand-lg navbar-light bg-transparent">
<a class=navbar-brand href=https://project-gutenberg.github.io/Pincong/><img class=img-fluid src=https://project-gutenberg.github.io/Pincong//images/logo.png alt=品葱*精选></a>
<button class="navbar-toggler border-0" type=button data-toggle=collapse data-target=#navigation>
<i class="ti-menu h3"></i>
</button>
<div class="collapse navbar-collapse text-center" id=navigation>
<ul class="navbar-nav ml-auto">
<li class=nav-item>
<a class=nav-link href=https://project-gutenberg.github.io/Pincong/> Home </a>
</li>
<li class=nav-item>
<a class=nav-link href=https://project-gutenberg.github.io/Pincong/post/index.xml>RSS</a>
</li>
<li class=nav-item>
<a class=nav-link href=https://bit.ly/2HrxEi0>Telegram</a>
</li>
<li class=nav-item>
<a class=nav-link href=https://twitter.com/speechfree3>Twitter</a>
</li>
</ul>
</div>
</nav>
</div>
</header> <div class="py-5 d-none d-lg-block"></div>
<section class=main-content>
<div class=container>
<div class=row>
<div class="col-lg-8 mx-auto block shadow mb-5">
<h2>SS/SSR做负载均衡的两种方法-荒岛</h2>
<div class=mb-3><span>by <a href=https://project-gutenberg.github.io/Pincong/author/></a></span>,
<span>at 05 May 2020</span>, tags :
<a href=https://project-gutenberg.github.io/Pincong/tags/%e6%9c%8d%e5%8a%a1%e5%99%a8>服务器</a>
<a href=https://project-gutenberg.github.io/Pincong/tags/%e7%ab%af%e5%8f%a3>端口</a>
<a href=https://github.com/Project-Gutenberg/Pincong-data/edit/master/site/content/post/219aaf5aed6b4b3bbef07053b7f841ca.md style=color:gray><strong><i>点击纠错</i></strong></a>
<i> </i>
<a href=https://github.com/Project-Gutenberg/Pincong-data/delete/master/site/content/post/219aaf5aed6b4b3bbef07053b7f841ca.md style=color:gray><strong><i>点击删除</i></strong></a>
</div>
<h5><a href="https://justmysocks.net/members/aff.php?aff=13681">使用CN2/CN2GIA顶级线路，支持Shadowsocks/V2ray科学上网，支持支付宝付款，每月仅需 5 美元</a></h5>
<h5><a href=https://bit.ly/2HrxEi0>## 加入品葱精选 Telegram Channel ##</a></h5>
<p></p>
<p><a href="https://bwh88.net/aff.php?aff=36696&pid=72"><img src="https://images.weserv.nl/?url=https%3A//wx4.sinaimg.cn/large/0062WjpGgy1fvftx9j0gnj30ms01ojs4.jpg" alt></a></p>
<p>负载均衡最大的作用就是0宕机，可以做到宕机秒切换。SS/SSR的PC客户端都有负载均衡的功能，而且还可以根据延迟进行负载均衡，但iOS端就有点蛋疼了，一直使用PotatsoLite的我有时候真的挺需要这个功能的。</p>
<p>这里介绍两种方法，第一种用HAProxy，第二种用Nginx。个人推荐用Nginx，因为HAProxy不支持UDP，如果是用来玩游戏，那就有点蛋疼了。而且有时候也确实需要用到UDP。</p>
<p>这里我准备了3台机器，一台用来做负载均衡服务器，另外两台跑SSR服务，实现功能：两台SSR机器如有某一台挂了，本地客户端可以自动切换并连接到正常运行的那一台。</p>
<p>这里补充一下，LEDE软路由是有这个HAProxy功能的，而且做SS/SSR负载均衡的话，建议HAProxy是搭建在本地，因为如果你搭建在服务器上，你跑HAProxy的那台机器挂了也就失去了负载均衡的意义。</p>
<p>两个前提条件：</p>
<p>1：所有的SS/SSR密码必须一致。</p>
<p>2：所有的SS/SSR加密方式必须一致。如果是SSR，那么协议/混淆也必须一致。</p>
<p>先安装：</p>
<p>yum -y install haproxy</p>
<p>将默认的配置文件做一个备份：</p>
<p>mv /etc/haproxy/haproxy.cfg /etc/haproxy/haproxy.cfg.bak</p>
<p>新建一个配置文件：</p>
<p>nano /etc/haproxy/haproxy.cfg</p>
<p>写入下面的配置：</p>
<p>global
chroot /var/lib/haproxy
pidfile /var/run/haproxy.pid
user haproxy
group haproxy</p>
<p>defaults
mode tcp #服务器默认的工作模式
balance roundrobin #服务器默认使用的均衡模式
retries 3 #三次连接失败表示服务器不可用
maxconn 5000 #最大连接数
timeout connect 500ms #连接超时
timeout client 3s #客户端超时
timeout server 3s #服务器超时</p>
<p>listen WebPanel
mode http #这里使用HTTP模式
bind 0.0.0.0:50000 #WEB服务端口
stats refresh 5s #自动刷新时间
stats uri / #WEB管理地址
stats auth imlala:lala.im #账号密码
stats hide-version #隐藏版本
stats admin if TRUE #验证通过则赋予管理权</p>
<p>listen USA
bind 0.0.0.0:50001 #服务端口
server usa1 1.2.3.4:55555 check inter 500 rise 2 fall 4 weight 100 #SS/SSR服务器地址与端口
server usa2 2.2.3.4:55555 check inter 500 rise 2 fall 4 weight 50 #SS/SSR服务器地址与端口</p>
<p>listen JP
bind 0.0.0.0:50002 #服务端口
server jp1 3.2.3.4:55555 check inter 500 rise 2 fall 4 weight 100 #SS/SSR服务器地址与端口
server jp2 4.2.3.4:55555 check inter 500 rise 2 fall 4 weight 50 #SS/SSR服务器地址与端口</p>
<p>这里详细说一下这个配置里面的各项作用：</p>
<p>首先你需要将listen WebPanel段下的web管理员账户密码做一下修改。然后你就可以看到listen USA/JP这两段这里了。</p>
<p>一个listen代表一个服务，你可以把它分为多个组。现在假设你在美国有2台机器，日本有2台机器，那么就可以分成两组，组与组之间没有联系，HAProxy只会给在同一个组里面的机器做负载均衡。但这样我们得在HAProxy内起两个服务端口，一个端口用于美国，一个端口用于日本。如果你想将所有的机器都加在一个组里面也是可以的，这样就可以让4台机器做负载均衡。怎么选择看你自己。</p>
<p>server后面首先跟名字，名字随便起呗，自己能够区分就行。紧接着跟这台机器的公网IP+端口，端口也就是SS/SSR的端口。</p>
<p>check是检测的意思，这段配置很重要：</p>
<p>inter：单位毫秒，我配置的500，即500毫秒检测一次目标服务器。</p>
<p>rise2：设定健康状态检查中，某离线的服务器从离线状态转换至正常状态需要成功检查的次数，这里我设置的2次。</p>
<p>fall4：确认服务器从正常状态转换为不可用状态需要检查的次数，这里是4次。</p>
<p>weight：权重，值越大代表这台机器工作的机会越多，这里我们可以把一台线路较好的机器的权重设置高一些。</p>
<p>配置完成之后，务必关闭SELinux，否则我们无法使用systemd去正常运行HAProxy（这是一个坑）：</p>
<p>sed -i &rsquo;s/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config
setenforce 0</p>
<p>启动HAProxy：</p>
<p>systemctl start haproxy
systemctl enable haproxy</p>
<p>这样HAProxy就配置好了，可以访问WEB面板确认服务器是否都在正常工作，如下图显示绿色就是正常：</p>
<p><a href="https://images.weserv.nl/?url=https%3A//lala.im/wp-content/uploads/2019/04/lala.im_2019-04-28_18-02-11.png"><img src="https://images.weserv.nl/?url=https%3A//lala.im/wp-content/uploads/2019/04/lala.im_2019-04-28_18-02-11.png" alt></a></p>
<p>本地客户端在配置的时候就填写这台HAProxy服务器的IP+服务端口。</p>
<p>因为我这边目前正在使用LEDE软路由，我的推荐是有LEDE那就直接在LEDE上面设置：</p>
<p><a href="https://images.weserv.nl/?url=https%3A//lala.im/wp-content/uploads/2019/04/lala.im_2019-04-28_18-22-29.png"><img src="https://images.weserv.nl/?url=https%3A//lala.im/wp-content/uploads/2019/04/lala.im_2019-04-28_18-22-29.png" alt></a></p>
<p>这样设置之后并没有完成，HAProxy甚至都不会运行，我们还需要添加一个节点：</p>
<p><a href="https://images.weserv.nl/?url=https%3A//lala.im/wp-content/uploads/2019/04/lala.im_2019-04-28_18-23-16.png"><img src="https://images.weserv.nl/?url=https%3A//lala.im/wp-content/uploads/2019/04/lala.im_2019-04-28_18-23-16.png" alt></a></p>
<p>之后把账号设置里面的节点改为刚才添加的，如果在上方多出一个“负载均衡”的检测就说明配置完成：</p>
<p><a href="https://images.weserv.nl/?url=https%3A//lala.im/wp-content/uploads/2019/04/lala.im_2019-04-28_18-23-45.png"><img src="https://images.weserv.nl/?url=https%3A//lala.im/wp-content/uploads/2019/04/lala.im_2019-04-28_18-23-45.png" alt></a></p>
<p>现在介绍Nginx的方法，还是先安装：</p>
<p>yum -y install nginx</p>
<p>然后在Nginx的主配置文件内写一个include，因为我们需要用到stream段，这个段和http段是平级的，不能内嵌到http段使用：</p>
<p>echo &ldquo;include /etc/nginx/tcpconf.d/*.conf;&rdquo; &#187; /etc/nginx/nginx.conf</p>
<p>创建一个存放配置文件的目录：</p>
<p>mkdir -p /etc/nginx/tcpconf.d</p>
<p>新建一个配置文件：</p>
<p>nano /etc/nginx/tcpconf.d/ssproxy.conf</p>
<p>写入如下配置：</p>
<p>stream {</p>
<pre><code>upstream imlala {
    server 1.2.3.4:55555 weight=7;
    server 2.2.3.4:55555 weight=3;
}

server {
listen 50003;
    listen 50003 udp;
    proxy\_pass imlala;
}
</code></pre>
<p>}</p>
<p>这边我使用的是weight（权重）模式，可以去掉这两个设置让Nginx默认用于轮询模式。</p>
<p>最后我还看了一下Caddy，结果发现很可惜这个WEB服务器目前还不能够支持TCP/UDP的负载均衡，但可以实现中转的功能，并且配置也很简单，这里顺带记录一下。</p>
<p>首先在安装的时候得添加net插件：</p>
<p>curl <a href=https://getcaddy.com>https://getcaddy.com</a> | bash -s personal net</p>
<p>然后新建配置文件：</p>
<p>nano /etc/caddy/Caddyfile</p>
<p>写入如下配置就能进行中转了：</p>
<p>proxy :50004 1.2.3.4:55555 {
}</p>
<p>proxy :50005 2.2.3.4:55555 {
}</p>
<p>注意，此时的Caddy启动时必须加上-type=net，插件功能才能生效：</p>
<p>caddy -type=net -conf=/etc/caddy/Caddyfile</p>
<h5> <a href="https://www.digitalocean.com/?refcode=4351d40e44b2&utm_campaign=Referral_Invite&utm_medium=Referral_Program&utm_source=CopyPaste">最简单好用的 VPS,没有之一，注册立得 100 美金</a></h5>
</div>
<div class="col-lg-8 mx-auto block shadow">
<div id=disqus_thread></div>
<script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//pin-cong-jing-xuan.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script>
<noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>
<a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
</div>
<div class="col-lg-8 mx-auto block shadow">
<h3>See Also</h3>
<div class=container>
<div class=row>
<div class="mx-auto px-0">
<div class="bg-white shadow block">
<article class=mb-5>
<h2 class=h5><a class=text-dark href="https://project-gutenberg.github.io/Pincong/post/16c147e99745aee701fe6e9fee34e466/?utm_source=see_also&utm_medium=ss%2fssr%25E5%2581%259A%25E8%25B4%259F%25E8%25BD%25BD%25E5%259D%2587%25E8%25A1%25A1%25E7%259A%2584%25E4%25B8%25A4%25E7%25A7%258D%25E6%2596%25B9%25E6%25B3%2595-%25E8%258D%2592%25E5%25B2%259B">shadowsocks借助nginx实现负载均衡，自动切换“零”宕机</a>
</h2>
<p class=text-dark>现在服务器（vps）的入门配置一般内存在512M，甚至有更小的256M、128M，小到“发指”，被戏称为“小鸡”。随着vps的价格一路狂跌，再遇上打折促销，加上季付年付等优惠手段，你完全能在1、2美元左右淘到一个512M内存的vps。当我们 …</p>
</article>
<article class=mb-5>
<h2 class=h5><a class=text-dark href="https://project-gutenberg.github.io/Pincong/post/3ebf688ba7b88b8bd0b0bbce3b8dfa43/?utm_source=see_also&utm_medium=ss%2fssr%25E5%2581%259A%25E8%25B4%259F%25E8%25BD%25BD%25E5%259D%2587%25E8%25A1%25A1%25E7%259A%2584%25E4%25B8%25A4%25E7%25A7%258D%25E6%2596%25B9%25E6%25B3%2595-%25E8%258D%2592%25E5%25B2%259B">同一个宇宙</a>
</h2>
<p class=text-dark>冰岛最著名的太空科幻游戏，EVE，在国内被译作《星战前夜》。这是个小误译，在游戏设定中，人类穿过EVE之门来到新伊甸星系，并建立新的家园。这里的eve不是前夜的意思，而是典指夏娃。
EVE的开发公司叫CCP，和我们的执政党缩写一样。
03年 …</p>
</article>
<article class=mb-5>
<h2 class=h5><a class=text-dark href="https://project-gutenberg.github.io/Pincong/post/3dc222d3c342eed659d19f0e954f390e/?utm_source=see_also&utm_medium=ss%2fssr%25E5%2581%259A%25E8%25B4%259F%25E8%25BD%25BD%25E5%259D%2587%25E8%25A1%25A1%25E7%259A%2584%25E4%25B8%25A4%25E7%25A7%258D%25E6%2596%25B9%25E6%25B3%2595-%25E8%258D%2592%25E5%25B2%259B">翻墙软件与中国VPN推荐，2020年5月最新 - 墙妈妈</a>
</h2>
<p class=text-dark>最后修改于： 2020年6月6日
翻墙软件现状 市场上的翻墙软件多如牛毛，如果你有幸访问国外苹果/安卓应用商店，搜一下”VPN”，能找到几十上百款APP，其中大部分我都试过，没几个能用的。我原本想做一次地毯式测试，但后来失去了耐心，实在太 …</p>
</article>
<article class=mb-5>
<h2 class=h5><a class=text-dark href="https://project-gutenberg.github.io/Pincong/post/f7b0523cf6dbc0e8a27e959abc9d5d59/?utm_source=see_also&utm_medium=ss%2fssr%25E5%2581%259A%25E8%25B4%259F%25E8%25BD%25BD%25E5%259D%2587%25E8%25A1%25A1%25E7%259A%2584%25E4%25B8%25A4%25E7%25A7%258D%25E6%2596%25B9%25E6%25B3%2595-%25E8%258D%2592%25E5%25B2%259B">Shadowsocks无法使用后的简单排除方法 | 逗比根据地</a>
</h2>
<p class=text-dark>广告
本文最后更新于 2018年11月7日 18:53 可能会因为没有更新而失效。如已失效或需要修正，请留言！
每一个使用过Shadowsocks的人，几乎都会出现过Shadowsocks突然无法使用的情况，然而很多人并不知道怎么办，网上 …</p>
</article>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
<script>var images=document.getElementsByTagName("img"),i;for(i=0;i<images.length;i++)images[i].className+="img-fluid w-100 mb-4"</script>
<footer class="py-4 bg-light border-top">
<div class=container>
<div class="row justify-content-between align-items-center">
<div class="col-lg-4 text-center text-lg-left mb-4 mb-lg-0">
<a href=https://project-gutenberg.github.io/Pincong/><img src=https://project-gutenberg.github.io/Pincong//images/logo.png class=img-fluid alt=品葱*精选></a>
</div>
<div class="col-lg-4 text-center mb-4 mb-lg-0">
<ul class="list-inline mb-0">
</ul>
</div>
<div class="col-lg-4 text-lg-right text-center mb-4 mb-lg-0">
<ul class="list-inline social-icon mb-0">
<li class=list-inline-item><a href=https://pincong.rocks/><i class=ti-home></i></a></li>
<li class=list-inline-item><a href=https://github.com/Project-Gutenberg/Pincong><i class=ti-github></i></a></li>
</ul>
</div>
<div class="col-12 text-center mt-4">
<span></span>
</div>
</div>
</div>
</footer>
<script src=../../plugins/jQuery/jquery.min.js></script>
<script src=../../plugins/bootstrap/bootstrap.min.js></script>
<script src=../../plugins/search/fuse.min.js></script>
<script src=../../plugins/search/mark.js></script>
<script src=../../plugins/search/search.js></script>
<script src=https://project-gutenberg.github.io/Pincong/js/script.min.js></script>
<script>(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)})(window,document,'script','//www.google-analytics.com/analytics.js','ga'),ga('create','UA-151212685-6','auto'),ga('send','pageview')</script></body>
</html>