<!doctype html><html lang=zh-cn><head>
<meta charset=utf-8>
<title>多Shadowsocks服务器负载均衡</title>
<meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1">
<meta name=description content=" 玩翻墙主机的人哪个没有好几个小鸡，所以多主机负载均衡访问这个需求应运而生，开源软件界当然已经有可以解决这个问题的软件——Haproxy
 HAProxy是一个使用C语言编写的基于TCP和HTTP的应用程序代理，其提供高可用性、负载均衡。
 整套系统的流程如图
Haproxy 安装就不必多讲了，直接看看配置文件，默认在/etc/haproxy/haproxy.cfg
global log /dev/log local0 log /dev/log local1 notice user root group root daemon defaults log global mode tcp timeout connect 5s timeout client 5s timeout server 5s option dontlognull option redispatch retries 3 listen status bind *:1111 mode http stats refresh 30s stats uri /status stats realm Haproxy stats auth admin:admin frontend shadowsocks-in mode tcp bind *:8388 default_backend shadowsocks-out backend shadowsocks-out mode tcp option tcp-check balance roundrobin server servername1 xxxxx1. ">
<meta name=generator content="Hugo 0.91.2">
<link rel=stylesheet href=../../plugins/bootstrap/bootstrap.min.css>
<link rel=stylesheet href=../../plugins/themify-icons/themify-icons.css>
<link rel=stylesheet href=https://project-gutenberg.github.io/Pincong/scss/style.min.css media=screen>
<link rel="shortcut icon" href=https://project-gutenberg.github.io/Pincong/images/favicon.png type=image/x-icon>
<link rel=icon href=https://project-gutenberg.github.io/Pincong/images/favicon.png type=image/x-icon>
<meta name=twitter:card content="summary_large_image">
<meta name=og:title content=" 多Shadowsocks服务器负载均衡 ">
<meta name=og:description content=" 玩翻墙主机的人哪个没有好几个小鸡，所以多主机负载均衡访问这个需求应运而生，开源软件界当然已经有可以解决这个问题的软件——Haproxy
 HAProxy是一个使用C语言编写的基于TCP和HTTP的应用程序代理，其提供高可用性、负载均衡。
 整套系统的流程如图
Haproxy 安装就不必多讲了，直接看看配置文件，默认在/etc/haproxy/haproxy.cfg
global log /dev/log local0 log /dev/log local1 notice user root group root daemon defaults log global mode tcp timeout connect 5s timeout client 5s timeout server 5s option dontlognull option redispatch retries 3 listen status bind *:1111 mode http stats refresh 30s stats uri /status stats realm Haproxy stats auth admin:admin frontend shadowsocks-in mode tcp bind *:8388 default_backend shadowsocks-out backend shadowsocks-out mode tcp option tcp-check balance roundrobin server servername1 xxxxx1. ">
<meta name=og:image content="https://project-gutenberg.github.io/Pincong//images/card/104.jpg">
<script data-ad-client=ca-pub-6074407261372769 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-06HJ1E5XNH"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-06HJ1E5XNH')</script>
</head>
<body>
<header class="fixed-top navigation">
<div class=container>
<nav class="navbar navbar-expand-lg navbar-light bg-transparent">
<a class=navbar-brand href=https://project-gutenberg.github.io/Pincong/><img class=img-fluid src=https://project-gutenberg.github.io/Pincong//images/logo.png alt=品葱*精选></a>
<button class="navbar-toggler border-0" type=button data-toggle=collapse data-target=#navigation>
<i class="ti-menu h3"></i>
</button>
<div class="collapse navbar-collapse text-center" id=navigation>
<ul class="navbar-nav ml-auto">
<li class=nav-item>
<a class=nav-link href=https://project-gutenberg.github.io/Pincong/> Home </a>
</li>
<li class=nav-item>
<a class=nav-link href=https://project-gutenberg.github.io/Pincong/post/index.xml>RSS</a>
</li>
<li class=nav-item>
<a class=nav-link href=https://bit.ly/2HrxEi0>Telegram</a>
</li>
<li class=nav-item>
<a class=nav-link href=https://twitter.com/speechfree3>Twitter</a>
</li>
</ul>
</div>
</nav>
</div>
</header> <div class="py-5 d-none d-lg-block"></div>
<section class=main-content>
<div class=container>
<div class=row>
<div class="col-lg-8 mx-auto block shadow mb-5">
<h2>多Shadowsocks服务器负载均衡</h2>
<div class=mb-3><span>by <a href=https://project-gutenberg.github.io/Pincong/author/kevin-chen>Kevin chen</a></span>,
<span>at 05 May 2020</span>, tags :
<a href=https://project-gutenberg.github.io/Pincong/tags/%e9%85%8d%e7%bd%ae>配置</a>
<a href=https://github.com/Project-Gutenberg/Pincong-data/edit/master/site/content/post/73866435b69ea6cfe569d099476deee9.md style=color:gray><strong><i>点击纠错</i></strong></a>
<i> </i>
<a href=https://github.com/Project-Gutenberg/Pincong-data/delete/master/site/content/post/73866435b69ea6cfe569d099476deee9.md style=color:gray><strong><i>点击删除</i></strong></a>
</div>
<h5><a href=https://bit.ly/justmysock>使用CN2/CN2GIA顶级线路，支持Shadowsocks/V2ray科学上网，支持支付宝付款，每月仅需 5 美元</a></h5>
<h5><a href=https://bit.ly/2HrxEi0>## 加入品葱精选 Telegram Channel ##</a></h5>
<p></p>
<p>玩翻墙主机的人哪个没有好几个小鸡，所以多主机负载均衡访问这个需求应运而生，开源软件界当然已经有可以解决这个问题的软件——Haproxy</p>
<blockquote>
<p>HAProxy是一个使用C语言编写的基于TCP和HTTP的应用程序代理，其提供高可用性、负载均衡。</p>
</blockquote>
<p>整套系统的流程如图</p>
<p><img src="https://images.weserv.nl/?url=https%3A//wx1.sinaimg.cn/large/65f2a787ly1fxvwgijay1j20gh0hhaaj.jpg" alt=流程图></p>
<h2 id=haproxy>Haproxy</h2>
<p>安装就不必多讲了，直接看看配置文件，默认在<code>/etc/haproxy/haproxy.cfg</code></p>
<p><code>global log /dev/log local0 log /dev/log local1 notice user root group root daemon defaults log global mode tcp timeout connect 5s timeout client 5s timeout server 5s option dontlognull option redispatch retries 3 listen status bind *:1111 mode http stats refresh 30s stats uri /status stats realm Haproxy stats auth admin:admin frontend shadowsocks-in mode tcp bind *:8388 default_backend shadowsocks-out backend shadowsocks-out mode tcp option tcp-check balance roundrobin server servername1 xxxxx1.com:8088 check server servername2 xxxxx2.net:8080 check server servername3 12.34.56.78:9999 check server servername4 123.234.234.123:443 check</code></p>
<p>配置分为五大部分：</p>
<p><code>global</code>:全局配置，我这里主要是配置了日志</p>
<p><code>defaults</code>:默认配置，也是一些全局配置，没什么好说的</p>
<p><code>listen</code>:监听配置，我在本机1111端口配置了http监控页面</p>
<p><code>frontend</code>:前端配置，Shadowsocks数据流从这里进入，流向指定后端</p>
<p><code>backend</code>:后端配置，<code>balance</code>指定负载平衡方式，每个服务器写为一个server行，server支持域名或IP，如果你想使用域名，那么必须要看看我之前写的<a href=https://www.solarck.com/systemd-wait-network-online.html>解决 Haproxy 用 Systemd 启动失败的问题</a>，不然肯定会出问题。</p>
<blockquote>
<p>我能用到就负载平衡方式只有简单的几种，复杂的需要查文档</p>
<p>roundrobin：简单轮询</p>
<p>static-rr：根据权重分配，权重在后端server中设置</p>
<p>leastconn：根据服务器最少连接分配，这个模式适合长连接应用</p>
</blockquote>
<h2 id=shadowsocks>Shadowsocks</h2>
<p>新建一个配置文件<code>/etc/shadowsocks/Shadowsocks-haproxy.json</code>，内容如下：</p>
<p><code>{ "server": "127.0.0.1", "server_port": 8388, "local_address": "127.0.0.1", "local_port": 65509, "password": "password", "timeout": 30, "method": "chacha20-ietf-poly1305", "fast_open": true, "workers": 2 }</code></p>
<h2 id=启动>启动</h2>
<p>首先要启动haproxy服务</p>
<p><code>systemctl enable haproxy.service systemctl start haproxy.service</code></p>
<p>只需要启动一个Shadowsocks服务就可以实现多服务器负载均衡了</p>
<p><code>systemctl enable shadowsocks-libev@Shadowsocks-haproxy.service systemctl start shadowsocks-libev@Shadowsocks-haproxy.service</code></p>
<h2 id=监控图形界面>监控图形界面</h2>
<p><img src="https://images.weserv.nl/?url=https%3A//wx1.sinaimg.cn/large/65f2a787ly1fxvwgg6nalj21h70ebwhp.jpg" alt=监控></p>
<h5> <a href="https://www.digitalocean.com/?refcode=4351d40e44b2&utm_campaign=Referral_Invite&utm_medium=Referral_Program&utm_source=CopyPaste">最简单好用的 VPS,没有之一，注册立得 100 美金</a></h5>
</div>
<div class="col-lg-8 mx-auto block shadow">
<div id=disqus_thread></div>
<script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//pin-cong-jing-xuan.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script>
<noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>
<a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
</div>
<div class="col-lg-8 mx-auto block shadow">
<h3>See Also</h3>
<div class=container>
<div class=row>
<div class="mx-auto px-0">
<div class="bg-white shadow block">
<article class=mb-5>
<h2 class=h5><a class=text-dark href="https://project-gutenberg.github.io/Pincong/post/ef3899ddc6d6269b165a4da5a09718ae/?utm_source=see_also&utm_medium=%25E5%25A4%259Ashadowsocks%25E6%259C%258D%25E5%258A%25A1%25E5%2599%25A8%25E8%25B4%259F%25E8%25BD%25BD%25E5%259D%2587%25E8%25A1%25A1">用 Haproxy 实现多 VPS 线路负载均衡 - Tian Wenshan | Wenshan&rsquo;s Blog</a>
</h2>
<p class=text-dark>使用机场或者有多个小鸡的人，某个线路故障了，就得手动切换 ss 线路，实在太麻烦了，能不能自动负载均衡，使用可用的 VPS 呢？
答案是肯定的，这就是今天的主角—— Haproxy。
但是这个方案有个前提，那就是每个 ss 的密码和加密方式 …</p>
</article>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
<script>var images=document.getElementsByTagName("img"),i;for(i=0;i<images.length;i++)images[i].className+="img-fluid w-100 mb-4"</script>
<footer class="py-4 bg-light border-top">
<div class=container>
<div class="row justify-content-between align-items-center">
<div class="col-lg-4 text-center text-lg-left mb-4 mb-lg-0">
<a href=https://project-gutenberg.github.io/Pincong/><img src=https://project-gutenberg.github.io/Pincong//images/logo.png class=img-fluid alt=品葱*精选></a>
</div>
<div class="col-lg-4 text-center mb-4 mb-lg-0">
<ul class="list-inline mb-0">
</ul>
</div>
<div class="col-lg-4 text-lg-right text-center mb-4 mb-lg-0">
<ul class="list-inline social-icon mb-0">
<li class=list-inline-item><a href=https://pincong.rocks/><i class=ti-home></i></a></li>
<li class=list-inline-item><a href=https://github.com/Project-Gutenberg/Pincong><i class=ti-github></i></a></li>
</ul>
</div>
<div class="col-12 text-center mt-4">
<span></span>
</div>
</div>
</div>
</footer>
<script src=../../plugins/jQuery/jquery.min.js></script>
<script src=../../plugins/bootstrap/bootstrap.min.js></script>
<script src=../../plugins/search/fuse.min.js></script>
<script src=../../plugins/search/mark.js></script>
<script src=../../plugins/search/search.js></script>
<script src=https://project-gutenberg.github.io/Pincong/js/script.min.js></script>
<script>(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)})(window,document,'script','//www.google-analytics.com/analytics.js','ga'),ga('create','UA-151212685-6','auto'),ga('send','pageview')</script></body>
</html>