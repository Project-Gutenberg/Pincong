<!doctype html><html lang=zh-cn><head><meta charset=utf-8><title>使用HAProxy为Shadowsocks做负载平衡</title><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=description content=" 为了高可用，以及平衡多个Shadowsocks服务器流量，可以借助HAProxy代理+多个Shadowsocks服务端来配置一个Shadowsocks服务群。利用HAProxy的4层代理作流量分发，使用外部检查工具实时监控Shadowsocks服务器的状态，以完成服务群的配置。
HAProxy是一个高性能负载均衡/代理服务器，可以提供4/7层的TCP代理。通过HAProxy的负载均衡器，可以将TCP连接分发到多个Shadowsocks服务端。同时在外部工具的帮助下，HAProxy提供的服务检查功能也可以对多个服务可用性进行检查，进行多服务容灾处理。
整体架构如上图。有一些其它方案是把HAProxy放在Shadowsocks后面的，但这样就需要多个服务端使用相同的配置，即端口、密码和加密方式都一样。但这样不是很利于多个服务的维护，安全性也有一些影响，对于v2ray等混淆方案也是不支持的。放在前面可以有效支持多个不同配置的服务，只是这样HAProxy就无法直接检测到远程服务器的可用状态，因为它只与本地的ss-local交互。而本地的TCP连接检查一定是通过的，因此这样就失去了高可用功能了。
不过HAProxy提供了使用外部工具进行服务检查的功能，于是我写了一个专门用于测试Shadowsocks服务的检查脚本，其原理是按照Socks5协议和ss-local进行握手，再通过Shadowsocks建立ssl连接去请求google主页，看能否收到200 OK的回复。
源代码放在Github上：haproxy-shadowsocks-checker，编辑HAProxy的配置文件，修改配置如下：
检查结果： 声明: 评论属于其发表者所有,不代表本站的观点和立场.
路人甲 回复该留言 时间: 2020-04-14
非常棒的解决办法，遇到跟你同样的问题，用你的脚本解决了，多谢。 不过那代码在 ubuntu16.04 不能运行，python和openssl版本不行，升级到ubuntu18.04搞定。
sbw 回复该留言 时间: 2020-04-17
要注意是 Python3，不能是 Python2，而且对应的依赖包也要安装
已有 2 位网友发表了一针见血的评论，你还等什么？ "><meta name=generator content="Hugo 0.100.2"><link rel=stylesheet href=../../plugins/bootstrap/bootstrap.min.css><link rel=stylesheet href=../../plugins/themify-icons/themify-icons.css><link rel=stylesheet href=https://project-gutenberg.github.io/Pincong/scss/style.min.css media=screen><link rel="shortcut icon" href=https://project-gutenberg.github.io/Pincong/images/favicon.png type=image/x-icon><link rel=icon href=https://project-gutenberg.github.io/Pincong/images/favicon.png type=image/x-icon><meta name=twitter:card content="summary_large_image"><meta name=og:title content=" 使用HAProxy为Shadowsocks做负载平衡 "><meta name=og:description content=" 为了高可用，以及平衡多个Shadowsocks服务器流量，可以借助HAProxy代理+多个Shadowsocks服务端来配置一个Shadowsocks服务群。利用HAProxy的4层代理作流量分发，使用外部检查工具实时监控Shadowsocks服务器的状态，以完成服务群的配置。
HAProxy是一个高性能负载均衡/代理服务器，可以提供4/7层的TCP代理。通过HAProxy的负载均衡器，可以将TCP连接分发到多个Shadowsocks服务端。同时在外部工具的帮助下，HAProxy提供的服务检查功能也可以对多个服务可用性进行检查，进行多服务容灾处理。
整体架构如上图。有一些其它方案是把HAProxy放在Shadowsocks后面的，但这样就需要多个服务端使用相同的配置，即端口、密码和加密方式都一样。但这样不是很利于多个服务的维护，安全性也有一些影响，对于v2ray等混淆方案也是不支持的。放在前面可以有效支持多个不同配置的服务，只是这样HAProxy就无法直接检测到远程服务器的可用状态，因为它只与本地的ss-local交互。而本地的TCP连接检查一定是通过的，因此这样就失去了高可用功能了。
不过HAProxy提供了使用外部工具进行服务检查的功能，于是我写了一个专门用于测试Shadowsocks服务的检查脚本，其原理是按照Socks5协议和ss-local进行握手，再通过Shadowsocks建立ssl连接去请求google主页，看能否收到200 OK的回复。
源代码放在Github上：haproxy-shadowsocks-checker，编辑HAProxy的配置文件，修改配置如下：
检查结果： 声明: 评论属于其发表者所有,不代表本站的观点和立场.
路人甲 回复该留言 时间: 2020-04-14
非常棒的解决办法，遇到跟你同样的问题，用你的脚本解决了，多谢。 不过那代码在 ubuntu16.04 不能运行，python和openssl版本不行，升级到ubuntu18.04搞定。
sbw 回复该留言 时间: 2020-04-17
要注意是 Python3，不能是 Python2，而且对应的依赖包也要安装
已有 2 位网友发表了一针见血的评论，你还等什么？ "><meta name=og:image content="https://project-gutenberg.github.io/Pincong//images/card/136.jpg"><script data-ad-client=ca-pub-6074407261372769 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-06HJ1E5XNH"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-06HJ1E5XNH')</script></head><body><header class="fixed-top navigation"><div class=container><nav class="navbar navbar-expand-lg navbar-light bg-transparent"><a class=navbar-brand href=https://project-gutenberg.github.io/Pincong/><img class=img-fluid src=https://project-gutenberg.github.io/Pincong//images/logo.png alt=品葱*精选></a>
<button class="navbar-toggler border-0" type=button data-toggle=collapse data-target=#navigation>
<i class="ti-menu h3"></i></button><div class="collapse navbar-collapse text-center" id=navigation><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=https://project-gutenberg.github.io/Pincong/>Home</a></li><li class=nav-item><a class=nav-link href=https://project-gutenberg.github.io/Pincong/post/index.xml>RSS</a></li><li class=nav-item><a class=nav-link href=https://bit.ly/2HrxEi0>Telegram</a></li><li class=nav-item><a class=nav-link href=https://twitter.com/speechfree3>Twitter</a></li></ul></div></nav></div></header><div class="py-5 d-none d-lg-block"></div><section class=main-content><div class=container><div class=row><div class="col-lg-8 mx-auto block shadow mb-5"><h2>使用HAProxy为Shadowsocks做负载平衡</h2><div class=mb-3><span>by <a href=https://project-gutenberg.github.io/Pincong/author/></a></span>,
<span>at 05 May 2020</span>, tags :
<a href=https://project-gutenberg.github.io/Pincong/tags/%e6%9c%8d%e5%8a%a1>服务</a>
<a href=https://project-gutenberg.github.io/Pincong/tags/%e6%a3%80%e6%9f%a5>检查</a>
<a href=https://github.com/Project-Gutenberg/Pincong-data/edit/master/site/content/post/e985d3fe92e6c8764f28e2ffc3651808.md style=color:gray><strong><i>点击纠错</i></strong></a>
<i></i><a href=https://github.com/Project-Gutenberg/Pincong-data/delete/master/site/content/post/e985d3fe92e6c8764f28e2ffc3651808.md style=color:gray><strong><i>点击删除</i></strong></a></div><h5><a href=https://bit.ly/justmysock>使用CN2/CN2GIA顶级线路，支持Shadowsocks/V2ray科学上网，支持支付宝付款，每月仅需 5 美元</a></h5><h5><a href=https://bit.ly/2HrxEi0>## 加入品葱精选 Telegram Channel ##</a></h5><p></p><p>为了高可用，以及平衡多个Shadowsocks服务器流量，可以借助HAProxy代理+多个Shadowsocks服务端来配置一个Shadowsocks服务群。利用HAProxy的4层代理作流量分发，使用外部检查工具实时监控Shadowsocks服务器的状态，以完成服务群的配置。</p><p>HAProxy是一个高性能负载均衡/代理服务器，可以提供4/7层的TCP代理。通过HAProxy的负载均衡器，可以将TCP连接分发到多个Shadowsocks服务端。同时在外部工具的帮助下，HAProxy提供的服务检查功能也可以对多个服务可用性进行检查，进行多服务容灾处理。</p><p><img src="https://images.weserv.nl/?url=../../picture/art-205-1.png" alt=haproxy-shadowsocks-proxy-load-balance></p><p>整体架构如上图。有一些其它方案是把HAProxy放在Shadowsocks后面的，但这样就需要多个服务端使用相同的配置，即端口、密码和加密方式都一样。但这样不是很利于多个服务的维护，安全性也有一些影响，对于v2ray等混淆方案也是不支持的。放在前面可以有效支持多个不同配置的服务，只是这样HAProxy就无法直接检测到远程服务器的可用状态，因为它只与本地的ss-local交互。而本地的TCP连接检查一定是通过的，因此这样就失去了高可用功能了。</p><p>不过HAProxy提供了使用外部工具进行服务检查的功能，于是我写了一个专门用于测试Shadowsocks服务的检查脚本，其原理是按照Socks5协议和ss-local进行握手，再通过Shadowsocks建立ssl连接去请求google主页，看能否收到200 OK的回复。</p><p>源代码放在Github上：<a href=https://github.com/sbwtw/haproxy-shadowsocks-checker>haproxy-shadowsocks-checker</a>，编辑HAProxy的配置文件，修改配置如下：</p><h5 id=检查结果>检查结果：</h5><p><img src="https://images.weserv.nl/?url=../../picture/art-205-2.png" alt=haproxy-shadowsocks-protocol-checker></p><ul><li><p>声明: 评论属于其发表者所有,不代表本站的观点和立场.</p></li><li><p>路人甲 回复该留言 时间: 2020-04-14</p><p>非常棒的解决办法，遇到跟你同样的问题，用你的脚本解决了，多谢。 不过那代码在 ubuntu16.04 不能运行，python和openssl版本不行，升级到ubuntu18.04搞定。</p></li><li><p>sbw 回复该留言 时间: 2020-04-17</p><p>要注意是 Python3，不能是 Python2，而且对应的依赖包也要安装</p></li></ul><p>已有 2 位网友发表了一针见血的评论，你还等什么？</p><h5><a href="https://www.digitalocean.com/?refcode=4351d40e44b2&utm_campaign=Referral_Invite&utm_medium=Referral_Program&utm_source=CopyPaste">最简单好用的 VPS,没有之一，注册立得 100 美金</a></h5></div><div class="col-lg-8 mx-auto block shadow"><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var t=document,e=t.createElement('script');e.async=!0,e.src='//pin-cong-jing-xuan.disqus.com/embed.js',e.setAttribute('data-timestamp',+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><div class="col-lg-8 mx-auto block shadow"><h3>See Also</h3><div class=container><div class=row><div class="mx-auto px-0"><div class="bg-white shadow block"><article class=mb-5><h2 class=h5><a class=text-dark href="https://project-gutenberg.github.io/Pincong/post/c471fb86d2d5b736752743e03aec4977/?utm_source=see_also&utm_medium=%25E4%25BD%25BF%25E7%2594%25A8haproxy%25E4%25B8%25BAshadowsocks%25E5%2581%259A%25E8%25B4%259F%25E8%25BD%25BD%25E5%25B9%25B3%25E8%25A1%25A1">乡村教师李田田，到底“惹”了什么事？央视白岩松《新闻1+1》深度调查</a></h2><p class=text-dark>来源：中央电视台等、干部关注编辑整理
10 月 10 日，湖南省湘西州永顺县桃子溪学校女教师李田田发表了一篇名为《一群正被毁掉的乡村孩子》（具体内容附后）的文章。
当地县教育局要求李田田连夜进城对其公号文章进行 “说明”。由于李田田并未答应 …</p></article></div></div></div></div></div></div></div></div></section><script>var i,images=document.getElementsByTagName("img");for(i=0;i<images.length;i++)images[i].className+="img-fluid w-100 mb-4"</script><footer class="py-4 bg-light border-top"><div class=container><div class="row justify-content-between align-items-center"><div class="col-lg-4 text-center text-lg-left mb-4 mb-lg-0"><a href=https://project-gutenberg.github.io/Pincong/><img src=https://project-gutenberg.github.io/Pincong//images/logo.png class=img-fluid alt=品葱*精选></a></div><div class="col-lg-4 text-center mb-4 mb-lg-0"><ul class="list-inline mb-0"></ul></div><div class="col-lg-4 text-lg-right text-center mb-4 mb-lg-0"><ul class="list-inline social-icon mb-0"><li class=list-inline-item><a href=https://pincong.rocks/><i class=ti-home></i></a></li><li class=list-inline-item><a href=https://github.com/Project-Gutenberg/Pincong><i class=ti-github></i></a></li></ul></div><div class="col-12 text-center mt-4"><span></span></div></div></div></footer><script src=../../plugins/jQuery/jquery.min.js></script>
<script src=../../plugins/bootstrap/bootstrap.min.js></script>
<script src=../../plugins/search/fuse.min.js></script>
<script src=../../plugins/search/mark.js></script>
<script src=../../plugins/search/search.js></script>
<script src=https://project-gutenberg.github.io/Pincong/js/script.min.js></script>
<script>(function(e,o,i,a,t,n,s){e.GoogleAnalyticsObject=t,e[t]=e[t]||function(){(e[t].q=e[t].q||[]).push(arguments)},e[t].l=1*new Date,n=o.createElement(i),s=o.getElementsByTagName(i)[0],n.async=1,n.src=a,s.parentNode.insertBefore(n,s)})(window,document,'script','//www.google-analytics.com/analytics.js','ga'),ga('create','UA-151212685-6','auto'),ga('send','pageview')</script></body></html>