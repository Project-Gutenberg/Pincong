<!doctype html><html lang=zh-cn><head><meta charset=utf-8><title>Nginx折腾－TCP代理和负载均衡</title><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=description content=" @orangleliu 2016-09-22T04:29:55.000000Z 字数 3080 阅读 9206
nginx
Nginx1.9 版本以后增加 stream模块，可以对tcp，udp请求进行代理和负载均衡了，今天来感受一下。
nginx streaming 文档地址
nginx streaming ssl 配置
Centos 6.7 openresty/1.9.15.1 (config时候增加选项 --with-stream --with-stream_ssl_module ) nginx对应版本1.9.3+以上，编译安装对于高版本nginx基本就是三板斧，所以掠过。
都在一个机器上， nginx监听30003端口，然后开两个窗口，用nc监听 7773，7774端口。
nginx配置
/ nc -l 7773 telnet--> nginx(30003) --> \ nc -l 7774 配置
stream { upstream backend { server 127.0.0.1:7773; server 127.0.0.1:7774; } server { listen 127. "><meta name=generator content="Hugo 0.100.2"><link rel=stylesheet href=../../plugins/bootstrap/bootstrap.min.css><link rel=stylesheet href=../../plugins/themify-icons/themify-icons.css><link rel=stylesheet href=https://project-gutenberg.github.io/Pincong/scss/style.min.css media=screen><link rel="shortcut icon" href=https://project-gutenberg.github.io/Pincong/images/favicon.png type=image/x-icon><link rel=icon href=https://project-gutenberg.github.io/Pincong/images/favicon.png type=image/x-icon><meta name=twitter:card content="summary_large_image"><meta name=og:title content=" Nginx折腾－TCP代理和负载均衡 "><meta name=og:description content=" @orangleliu 2016-09-22T04:29:55.000000Z 字数 3080 阅读 9206
nginx
Nginx1.9 版本以后增加 stream模块，可以对tcp，udp请求进行代理和负载均衡了，今天来感受一下。
nginx streaming 文档地址
nginx streaming ssl 配置
Centos 6.7 openresty/1.9.15.1 (config时候增加选项 --with-stream --with-stream_ssl_module ) nginx对应版本1.9.3+以上，编译安装对于高版本nginx基本就是三板斧，所以掠过。
都在一个机器上， nginx监听30003端口，然后开两个窗口，用nc监听 7773，7774端口。
nginx配置
/ nc -l 7773 telnet--> nginx(30003) --> \ nc -l 7774 配置
stream { upstream backend { server 127.0.0.1:7773; server 127.0.0.1:7774; } server { listen 127. "><meta name=og:image content="https://project-gutenberg.github.io/Pincong//images/card/224.jpg"><script data-ad-client=ca-pub-6074407261372769 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-06HJ1E5XNH"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-06HJ1E5XNH')</script></head><body><header class="fixed-top navigation"><div class=container><nav class="navbar navbar-expand-lg navbar-light bg-transparent"><a class=navbar-brand href=https://project-gutenberg.github.io/Pincong/><img class=img-fluid src=https://project-gutenberg.github.io/Pincong//images/logo.png alt=品葱*精选></a>
<button class="navbar-toggler border-0" type=button data-toggle=collapse data-target=#navigation>
<i class="ti-menu h3"></i></button><div class="collapse navbar-collapse text-center" id=navigation><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=https://project-gutenberg.github.io/Pincong/>Home</a></li><li class=nav-item><a class=nav-link href=https://project-gutenberg.github.io/Pincong/post/index.xml>RSS</a></li><li class=nav-item><a class=nav-link href=https://bit.ly/2HrxEi0>Telegram</a></li><li class=nav-item><a class=nav-link href=https://twitter.com/speechfree3>Twitter</a></li></ul></div></nav></div></header><div class="py-5 d-none d-lg-block"></div><section class=main-content><div class=container><div class=row><div class="col-lg-8 mx-auto block shadow mb-5"><h2>Nginx折腾－TCP代理和负载均衡</h2><div class=mb-3><span>by <a href=https://project-gutenberg.github.io/Pincong/author/jiawei-zhang>Jiawei zhang</a></span>,
<span>at 15 June 2020</span>, tags :
<a href=https://github.com/Project-Gutenberg/Pincong-data/edit/master/site/content/post/184be1de93f650fd0412511e7b1ff25f.md style=color:gray><strong><i>点击纠错</i></strong></a>
<i></i><a href=https://github.com/Project-Gutenberg/Pincong-data/delete/master/site/content/post/184be1de93f650fd0412511e7b1ff25f.md style=color:gray><strong><i>点击删除</i></strong></a></div><h5><a href=https://bit.ly/justmysock>使用CN2/CN2GIA顶级线路，支持Shadowsocks/V2ray科学上网，支持支付宝付款，每月仅需 5 美元</a></h5><h5><a href=https://bit.ly/2HrxEi0>## 加入品葱精选 Telegram Channel ##</a></h5><p></p><p><code>@orangleliu</code> <code>2016-09-22T04:29:55.000000Z</code> <code>字数 3080</code> <code>阅读 9206</code></p><p><code>nginx</code></p><blockquote><p><code>Nginx1.9</code> 版本以后增加 stream模块，可以对tcp，udp请求进行代理和负载均衡了，今天来感受一下。</p></blockquote><p><a href=https://nginx.org/en/docs/stream/ngx_stream_core_module.html>nginx streaming 文档地址</a><br><a href=https://www.nginx.com/resources/admin-guide/nginx-tcp-ssl-termination/>nginx streaming ssl 配置</a></p><ul><li>Centos 6.7</li><li>openresty/1.9.15.1 (config时候增加选项 <code>--with-stream --with-stream_ssl_module</code> )</li></ul><p>nginx对应版本1.9.3+以上，编译安装对于高版本nginx基本就是三板斧，所以掠过。</p><p>都在一个机器上， nginx监听30003端口，然后开两个窗口，用nc监听 7773，7774端口。<br>nginx配置</p><ol><li><code>/ nc -l 7773</code></li><li><code>telnet--> nginx(30003) --></code></li><li><code>\ nc -l 7774</code></li></ol><p>配置</p><ol><li><code>stream {</code></li><li><code>upstream backend {</code></li><li><code>server 127.0.0.1:7773;</code></li><li><code>server 127.0.0.1:7774;</code></li><li><code>}</code></li><li><code>server {</code></li><li><code>listen 127.0.0.1:30003;</code></li><li><code>proxy_timeout 20s;</code></li><li><code>proxy_pass backend;</code></li><li><code>}</code></li><li><code>}</code></li></ol><p>测试</p><p>第一次会代理到 7773端口，第二次会到7774端口，挺好用。</p><p>下面是一个ssl 然后ip hash方式的负载均衡（tcp也支持几种负载均衡方式 round-robin, least_conn least_time, hash等）</p><ol><li><p><code>stream {</code></p></li><li><p><code>upstream backend {</code></p></li><li><p><code>hash $remote_addr;</code></p></li><li><p><code>server 192.168.59.3:9344;</code></p></li><li><p><code>server 192.168.59.3:9345;</code></p></li><li><p><code>}</code></p></li><li><p><code>server {</code></p></li><li><p><code>listen 9344 ssl;</code></p></li><li><p><code>ssl_certificate /data/keys/CAcert.pem;</code></p></li><li><p><code>ssl_certificate_key /data/keys/privkey.pem;</code></p></li><li><p><code>ssl_session_cache shared:SSL:10m;</code></p></li><li><p><code>ssl_session_timeout 2h;</code></p></li><li><p><code>proxy_timeout 20s;</code></p></li><li><p><code>proxy_pass backend;</code></p></li><li><p><code>}</code></p></li><li><p><code>}</code></p></li></ol><p><strong>测试失败</strong></p><p>测试的场景：测试的主机是一台国外的VPS，代号host1。另外还有两个其他人的SS代理，用户名密码，以及加密方式都相同。 然后用host1代理host2, host3的ss服务，负载均衡使用轮训策略。 修改ss本地客户端配置，浏览器访问墙外的网站。</p><ol><li><code>/ host2(ss)</code></li><li><code>client --> host1(nginx)</code></li><li><code>\ host3(ss)</code></li></ol><ul><li><p>host1 63.221.100.34</p></li><li><p>host2 45.76.39.146</p></li><li><p>host3 23.83.123.88</p><ol><li><p>host2, host3 ss已经启动，端口都是 9999</p></li><li><p>host1 配置nginx, stream部分, 和 http块同级</p><ol><li><p><code>http {...}</code></p></li><li><p><code>stream {</code></p></li><li><p><code>upstream backend {</code></p></li><li><p><code>server 45.76.39.146:9999;</code></p></li><li><p><code>server 23.83.123.88:9999;</code></p></li><li><p><code>}</code></p></li><li><p><code>server {</code></p></li><li><p><code>listen 63.221.100.34:9000;</code></p></li><li><p><code>proxy_timeout 20s;</code></p></li><li><p><code>proxy_pass backend;</code></p></li><li><p><code>}</code></p></li><li><p><code>}</code></p></li></ol><p>配置完成重启nginx</p></li><li><p>本地ss 客户端指向host1的地址和端口</p></li><li><p>测试结果 无法正常访问google (从nginx errorlog中能看到，upstream tcp 已经起作用了, 可以代理到host2, host3, 就是没有成功)</p></li></ol></li></ul><p>错误如下，可以推断nginx能代理 TCP 请求，可是应用无法正常响应，怀疑proxy 方式来访问ss不好用。通过在host<br>1上抓包发现，host1可以往host2, host3发送请求。后来想一想nginx并不能完整的区分client的一个http请求，如果host2, host3只拿到http请求的部分tcp包，那么也无法正常代理（负载均衡的思路可以去掉了，后来想了下应该可以用ip hash来解决这个事）</p><ol><li><code>2016/08/23 23:25:25 [error] 27384#27384: *266 connect() failed (111: Connection refused) while connecting to upstream, client: 182.18.73.162, server: 63.221.100.34:9000, upstream: "45.76.39.146:9999", bytes from/to client:0/0, bytes from/to upstream:0/0</code></li><li><code>2016/08/23 23:26:15 [notice] 27388#27388: signal process started</code></li><li><code>2016/08/23 23:28:33 [error] 27389#27389: *768 recv() failed (104: Connection reset by peer) while proxying connection, client: 182.18.73.162, server: 63.221.100.34:9000, upstream: "23.83.123.88:9999", bytes from/to client:239/0, bytes from/to upstream:0/239</code></li></ol><p>现在不做负载均衡，只是配置一个backend来做tcp代理，于是注释掉host3.</p><ol><li><code>upstream backend {</code></li><li><code>server 45.76.39.146:9999;</code></li><li><code>#server 23.83.123.88:9999; # 后来掉一个backend</code></li><li><code>}</code></li></ol><p>在进行测试, 这次 打开host2上ss代理的 <code>-v</code> 模式</p><ol><li><code>root@fendou liuzhizhi]# ss-server -c /etc/shadowsocks.json -v</code></li><li><code>2016-08-24 02:18:39 INFO: initializing ciphers... aes-256-cfb</code></li><li><code>2016-08-24 02:18:39 INFO: port reuse enabled</code></li><li><code>2016-08-24 02:18:39 INFO: listening at 45.76.39.146:9999</code></li><li><code>2016-08-24 02:18:40 INFO: accept a connection</code></li><li><code>2016-08-24 02:18:40 INFO: connect to [7759:5fcd:7e17:aaef:2602:7373:56ec:d45e]:58426</code></li><li><code>2016-08-24 02:18:40 INFO: accept a connection</code></li><li><code>2016-08-24 02:18:40 ERROR: authentication error from 63.221.100.34</code></li><li><code>2016-08-24 02:18:40 INFO: current server connection: 1</code></li><li><code>2016-08-24 02:18:41 INFO: accept a connection</code></li><li><code>2016-08-24 02:18:41 ERROR: authentication error from 63.221.100.34</code></li><li><code>2016-08-24 02:18:41 INFO: current server connection: 1</code></li><li><code>2016-08-24 02:18:41 INFO: accept a connection</code></li><li><code>2016-08-24 02:18:41 ERROR: authentication error from 63.221.100.34</code></li></ol><p>浏览器测试还是不能正常代理，页面都无法打开。（具体原因还需查查）</p><p>nginx tcp proxy 安装，配置都比较简单，非常好。</p><h5><a href="https://www.digitalocean.com/?refcode=4351d40e44b2&utm_campaign=Referral_Invite&utm_medium=Referral_Program&utm_source=CopyPaste">最简单好用的 VPS,没有之一，注册立得 100 美金</a></h5></div><div class="col-lg-8 mx-auto block shadow"><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var t=document,e=t.createElement('script');e.async=!0,e.src='//pin-cong-jing-xuan.disqus.com/embed.js',e.setAttribute('data-timestamp',+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><div class="col-lg-8 mx-auto block shadow"><h3>See Also</h3><div class=container><div class=row><div class="mx-auto px-0"><div class="bg-white shadow block"></div></div></div></div></div></div></div></div></section><script>var i,images=document.getElementsByTagName("img");for(i=0;i<images.length;i++)images[i].className+="img-fluid w-100 mb-4"</script><footer class="py-4 bg-light border-top"><div class=container><div class="row justify-content-between align-items-center"><div class="col-lg-4 text-center text-lg-left mb-4 mb-lg-0"><a href=https://project-gutenberg.github.io/Pincong/><img src=https://project-gutenberg.github.io/Pincong//images/logo.png class=img-fluid alt=品葱*精选></a></div><div class="col-lg-4 text-center mb-4 mb-lg-0"><ul class="list-inline mb-0"></ul></div><div class="col-lg-4 text-lg-right text-center mb-4 mb-lg-0"><ul class="list-inline social-icon mb-0"><li class=list-inline-item><a href=https://pincong.rocks/><i class=ti-home></i></a></li><li class=list-inline-item><a href=https://github.com/Project-Gutenberg/Pincong><i class=ti-github></i></a></li></ul></div><div class="col-12 text-center mt-4"><span></span></div></div></div></footer><script src=../../plugins/jQuery/jquery.min.js></script>
<script src=../../plugins/bootstrap/bootstrap.min.js></script>
<script src=../../plugins/search/fuse.min.js></script>
<script src=../../plugins/search/mark.js></script>
<script src=../../plugins/search/search.js></script>
<script src=https://project-gutenberg.github.io/Pincong/js/script.min.js></script>
<script>(function(e,o,i,a,t,n,s){e.GoogleAnalyticsObject=t,e[t]=e[t]||function(){(e[t].q=e[t].q||[]).push(arguments)},e[t].l=1*new Date,n=o.createElement(i),s=o.getElementsByTagName(i)[0],n.async=1,n.src=a,s.parentNode.insertBefore(n,s)})(window,document,'script','//www.google-analytics.com/analytics.js','ga'),ga('create','UA-151212685-6','auto'),ga('send','pageview')</script></body></html>