<!doctype html><html lang=zh-cn><head><meta charset=utf-8><title>VPS下搭建ShadowSocks及Nginx实战</title><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=description content=" 最近入手了一美国VPS，128M内存，4G硬盘，年付6刀。。。白菜价。系统装的是CentOS 7，除了做ShadowSocks之外，还在上面搭建Nginx，记录下折腾的历程。
1、ShadowSocks的搭建已经很顺利了。。。 使用root用户登录，运行以下命令（这是三行。。。不要一次性复制执行，要运行三次）：
wget --no-check-certificate https://raw.githubusercontent.com/ElvizLai/ShadowSocks/master/shadowsocks.sh chmod +x shadowsocks.sh ./shadowsocks.sh 2>&1 | tee shadowsocks.log 完成后会有以下提示：
Congratulations, shadowsocks install completed! Your Server IP:your_server_ip Your Server Port:8989 Your Password:your_password Your Local IP:127.0.0.1 Your Local Port:1080 Your Encryption Method:aes-256-cfb Welcome to visit:http://teddysun.com/342.html Enjoy it! 配置文件路径：/etc/shadowsocks.json，使用vi打开，改成这样：
{ &#34;server&#34;:&#34;your_server_ip&#34;, &#34;local_address&#34;: &#34;127.0.0.1&#34;, &#34;local_port&#34;:1080, &#34;port_password&#34;:{ &#34;8989&#34;:&#34;password0&#34;, &#34;9001&#34;:&#34;password1&#34;, &#34;9002&#34;:&#34;password2&#34;, &#34;9003&#34;:&#34;password3&#34;, &#34;9004&#34;:&#34;password4&#34; }, &#34;timeout&#34;:60, &#34;method&#34;:&#34;aes-256-cfb&#34;, &#34;fast_open&#34;: false, &#34;workers&#34;: 1 } 很明显了吧。。。其中method部分要跟ss客户端部分一致，从安全角度上将选256，但是从效率角度上，我个人换成了128 "><meta name=generator content="Hugo 0.100.2"><link rel=stylesheet href=../../plugins/bootstrap/bootstrap.min.css><link rel=stylesheet href=../../plugins/themify-icons/themify-icons.css><link rel=stylesheet href=https://project-gutenberg.github.io/Pincong/scss/style.min.css media=screen><link rel="shortcut icon" href=https://project-gutenberg.github.io/Pincong/images/favicon.png type=image/x-icon><link rel=icon href=https://project-gutenberg.github.io/Pincong/images/favicon.png type=image/x-icon><meta name=twitter:card content="summary_large_image"><meta name=og:title content=" VPS下搭建ShadowSocks及Nginx实战 "><meta name=og:description content=" 最近入手了一美国VPS，128M内存，4G硬盘，年付6刀。。。白菜价。系统装的是CentOS 7，除了做ShadowSocks之外，还在上面搭建Nginx，记录下折腾的历程。
1、ShadowSocks的搭建已经很顺利了。。。 使用root用户登录，运行以下命令（这是三行。。。不要一次性复制执行，要运行三次）：
wget --no-check-certificate https://raw.githubusercontent.com/ElvizLai/ShadowSocks/master/shadowsocks.sh chmod +x shadowsocks.sh ./shadowsocks.sh 2>&1 | tee shadowsocks.log 完成后会有以下提示：
Congratulations, shadowsocks install completed! Your Server IP:your_server_ip Your Server Port:8989 Your Password:your_password Your Local IP:127.0.0.1 Your Local Port:1080 Your Encryption Method:aes-256-cfb Welcome to visit:http://teddysun.com/342.html Enjoy it! 配置文件路径：/etc/shadowsocks.json，使用vi打开，改成这样：
{ &#34;server&#34;:&#34;your_server_ip&#34;, &#34;local_address&#34;: &#34;127.0.0.1&#34;, &#34;local_port&#34;:1080, &#34;port_password&#34;:{ &#34;8989&#34;:&#34;password0&#34;, &#34;9001&#34;:&#34;password1&#34;, &#34;9002&#34;:&#34;password2&#34;, &#34;9003&#34;:&#34;password3&#34;, &#34;9004&#34;:&#34;password4&#34; }, &#34;timeout&#34;:60, &#34;method&#34;:&#34;aes-256-cfb&#34;, &#34;fast_open&#34;: false, &#34;workers&#34;: 1 } 很明显了吧。。。其中method部分要跟ss客户端部分一致，从安全角度上将选256，但是从效率角度上，我个人换成了128 "><meta name=og:image content="https://project-gutenberg.github.io/Pincong//images/card/29.jpg"><script data-ad-client=ca-pub-6074407261372769 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-06HJ1E5XNH"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-06HJ1E5XNH')</script></head><body><header class="fixed-top navigation"><div class=container><nav class="navbar navbar-expand-lg navbar-light bg-transparent"><a class=navbar-brand href=https://project-gutenberg.github.io/Pincong/><img class=img-fluid src=https://project-gutenberg.github.io/Pincong//images/logo.png alt=品葱*精选></a>
<button class="navbar-toggler border-0" type=button data-toggle=collapse data-target=#navigation>
<i class="ti-menu h3"></i></button><div class="collapse navbar-collapse text-center" id=navigation><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=https://project-gutenberg.github.io/Pincong/>Home</a></li><li class=nav-item><a class=nav-link href=https://project-gutenberg.github.io/Pincong/post/index.xml>RSS</a></li><li class=nav-item><a class=nav-link href=https://bit.ly/2HrxEi0>Telegram</a></li><li class=nav-item><a class=nav-link href=https://twitter.com/speechfree3>Twitter</a></li></ul></div></nav></div></header><div class="py-5 d-none d-lg-block"></div><section class=main-content><div class=container><div class=row><div class="col-lg-8 mx-auto block shadow mb-5"><h2>VPS下搭建ShadowSocks及Nginx实战</h2><div class=mb-3><span>by <a href=https://project-gutenberg.github.io/Pincong/author/></a></span>,
<span>at 01 December 2014</span>, tags :
<a href=https://github.com/Project-Gutenberg/Pincong-data/edit/master/site/content/post/dbc02f857c000e17010a034436230cc7.md style=color:gray><strong><i>点击纠错</i></strong></a>
<i></i><a href=https://github.com/Project-Gutenberg/Pincong-data/delete/master/site/content/post/dbc02f857c000e17010a034436230cc7.md style=color:gray><strong><i>点击删除</i></strong></a></div><h5><a href=https://bit.ly/justmysock>使用CN2/CN2GIA顶级线路，支持Shadowsocks/V2ray科学上网，支持支付宝付款，每月仅需 5 美元</a></h5><h5><a href=https://bit.ly/2HrxEi0>## 加入品葱精选 Telegram Channel ##</a></h5><p></p><p>最近入手了一美国VPS，128M内存，4G硬盘，年付6刀。。。白菜价。系统装的是CentOS 7，除了做ShadowSocks之外，还在上面搭建Nginx，记录下折腾的历程。</p><h3 id=1shadowsocks的搭建已经很顺利了>1、ShadowSocks的搭建已经很顺利了。。。</h3><p>使用root用户登录，运行以下命令（这是三行。。。不要一次性复制执行，要运行三次）：</p><pre><code>wget --no-check-certificate https://raw.githubusercontent.com/ElvizLai/ShadowSocks/master/shadowsocks.sh

chmod +x shadowsocks.sh

./shadowsocks.sh 2&gt;&amp;1 | tee shadowsocks.log
</code></pre><p>完成后会有以下提示：</p><pre><code>Congratulations, shadowsocks install completed!
Your Server IP:your_server_ip
Your Server Port:8989
Your Password:your_password
Your Local IP:127.0.0.1
Your Local Port:1080
Your Encryption Method:aes-256-cfb

Welcome to visit:http://teddysun.com/342.html
Enjoy it!
</code></pre><p>配置文件路径：<code>/etc/shadowsocks.json</code>，使用vi打开，改成这样：</p><pre><code>{
    &quot;server&quot;:&quot;your_server_ip&quot;,
    &quot;local_address&quot;: &quot;127.0.0.1&quot;,
    &quot;local_port&quot;:1080,
    &quot;port_password&quot;:{
         &quot;8989&quot;:&quot;password0&quot;,
         &quot;9001&quot;:&quot;password1&quot;,
         &quot;9002&quot;:&quot;password2&quot;,
         &quot;9003&quot;:&quot;password3&quot;,
         &quot;9004&quot;:&quot;password4&quot;
    },
    &quot;timeout&quot;:60,
    &quot;method&quot;:&quot;aes-256-cfb&quot;,
    &quot;fast_open&quot;: false,
    &quot;workers&quot;: 1
}
</code></pre><p>很明显了吧。。。其中method部分要跟ss客户端部分一致，从安全角度上将选256，但是从效率角度上，我个人换成了128</p><p>查看服务器状态的指令：</p><pre><code>启动：/etc/init.d/shadowsocks start
停止：/etc/init.d/shadowsocks stop
重启：/etc/init.d/shadowsocks restart
查看状态：/etc/init.d/shadowsocks status
</code></pre><p>另外还提供一个低内存版本的服务端，libev版，安装方法跟上面一样，只需要将地址改为：</p><pre><code>https://raw.githubusercontent.com/ElvizLai/ShadowSocks/master/shadowsocks-libev.sh
</code></pre><p>可能用的到的指令：</p><pre><code>卸载 ./shadowsocks-libev.sh uninstall
升级 pip install -U shadowsocks
</code></pre><p>好了，ShadowSocks的服务端安装就到此结束了！</p><p>-&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&ndash;灰机&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;-分割线&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&ndash;</p><h3 id=2nginx服务器反向代理搭建嗯各种不顺>2、Nginx服务器反向代理搭建。。。嗯，各种不顺</h3><p>Step1、升级库：<code>yum update</code></p><p>Step2、 安装make：<code>yum -y install gcc automake autoconf libtool make gcc-c++</code></p><p>For Ubuntu：<code>apt-get install build-essential</code></p><p>Setp3、 安装PCRE库</p><pre><code>cd /usr/local/src
wget ftp://ftp.csx.cam.ac.uk/pub/software/programming/pcre/pcre-8.38.tar.gz 
tar -zxvf pcre-8.38.tar.gz
cd pcre-8.38
./configure
make
make install
</code></pre><p>Step4、安装zlib库</p><pre><code>cd /usr/local/src
wget http://zlib.net/zlib-1.2.8.tar.gz
tar -zxvf zlib-1.2.8.tar.gz
cd zlib-1.2.8
./configure
make
make install
</code></pre><p>Step5、安装ssl，为了让网站显的正式一点，可以去startssl申请证书（但这样就要求自己必须有域名）。</p><pre><code>cd /usr/local/src
wget http://www.openssl.org/source/openssl-1.0.2f.tar.gz
tar -zxvf openssl-1.0.2f.tar.gz
</code></pre><p>Step6、 由于反向代理是需要http_sub_module模块的，所以安装该模块：</p><pre><code>cd /usr/local/src
git clone git://github.com/yaoweibin/ngx_http_substitutions_filter_module.git
#google模块，你懂
git clone git://github.com/cuber/ngx_http_google_filter_module
#加一份echo模块，用于调试
git clone git://github.com/openresty/echo-nginx-module
#fair负载均衡模块
git clone git://github.com/gnosek/nginx-upstream-fair
</code></pre><p>Step7、安装Nginx</p><pre><code>cd /usr/local/src
wget http://nginx.org/download/nginx-1.9.9.tar.gz
tar -zxvf nginx-1.9.9.tar.gz
cd nginx-1.9.9

./configure --sbin-path=/usr/local/nginx/nginx \
--conf-path=/usr/local/nginx/nginx.conf \
--pid-path=/usr/local/nginx/nginx.pid \
--with-http_ssl_module \
--with-http_v2_module \
--with-pcre=/usr/local/src/pcre-8.38 \
--with-zlib=/usr/local/src/zlib-1.2.8 \
--with-openssl=/usr/local/src/openssl-1.0.2f \
--with-http_sub_module \
--add-module=/usr/local/src/ngx_http_substitutions_filter_module \
--add-module=/usr/local/src/echo-nginx-module \
--add-module=/usr/local/src/ngx_http_google_filter_module \
--add-module=/usr/local/src/nginx-upstream-fair

make
make install
</code></pre><p>不出意外的话，一定在make结束后会提示错误「xx pod2man xx」。。。。都是pod2man惹的祸，简单粗暴的解决方案：</p><pre><code>rm /usr/bin/pod2man
make clean
./configure
make
make install
</code></pre><p><em>20141211添加-也可以试试阿里的Tengine</em></p><pre><code>wget -c http://tengine.taobao.org/download/tengine-2.1.2.tar.gz
tar zxvf tengine-2.1.2.tar.gz
cd tengine-2.1.2
//后面参照nginx部分
</code></pre><p>Step8、还差临门一脚，配置conf文件，达到反向代理的目的：</p><pre><code>自签发证书，或者使用startssl提供的证书
cd /usr/local/nginx/conf
openssl genrsa -out server.key 1024
openssl req -new -key server.key -out server.csr
openssl x509 -req -days 365 -in server.csr -signkey server.key -out server.crt
openssl dhparam -out dhparams.pem 4096
</code></pre><p>做个缓存</p><pre><code>mkdir -p /var/nginx/cache
chown -R root /var/nginx
</code></pre><p>编辑nginx.conf文件</p><pre><code>worker_processes 2;
pid nginx.pid;

events {
    worker_connections 1024;
    multi_accept on;
}

http {
    include mime.types;
    default_type application/octet-stream;

    server_tokens off;
    sendfile on;
    tcp_nopush on;

    keepalive_timeout 60;

    gzip on;
    gzip_disable &quot;msie6&quot;;
    gzip_proxied any;
    gzip_min_length 1000;

    proxy_cache_path /var/nginx/cache levels=1:2 keys_zone=cache:30m max_size=2g;
    proxy_cache_key &quot;$host$request_uri&quot;;
    
    upstream google {
        server 74.125.224.144 max_fails=3;
        server 74.125.224.145 max_fails=3;
        server 74.125.224.146 max_fails=3;
        server 74.125.224.147 max_fails=3;
        server 74.125.224.148 max_fails=3; 
    }

    server {
        listen 80;
        add_header Strict-Transport-Security max-age=16070400;
        server_name 你的域名;
        rewrite ^(.*) https://$server_name$1 permanent;
    }

    # HTTPS server
     server {
         listen 443 ssl spdy;
         server_name 你的域名;

         ssl_certificate /usr/local/nginx/conf/ssl.crt;
         ssl_certificate_key /usr/local/nginx/conf/ssl.key;

         ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
         ssl_ciphers ECDHE-RSA-AES256-SHA384:AES256-SHA256:RC4:HIGH:!MD5:!aNULL:!eNULL:!NULL:!DH:!EDH:!AESGCM;
         ssl_prefer_server_ciphers on;
         ssl_session_cache shared:SSL:5m;
         ssl_session_timeout 10m;

         location / {
              proxy_cache cache;
              proxy_cache_valid 200 302 1h;
              proxy_cache_valid 404 1m;
              proxy_redirect https://www.google.com/ /;
              proxy_cookie_domain google.com $server_name;
              proxy_pass http://google;
              proxy_set_header Host &quot;www.google.com&quot;;
              proxy_set_header Accept-Encoding &quot;&quot;;
              proxy_set_header User-Agent $http_user_agent;
              proxy_set_header Accept-Language &quot;zh-CN&quot;;
              proxy_set_header Cookie &quot;PREF=ID=047808f19f6de346:U=0f62f33dd8549d11:FF=2:LD=zh-CN:NW=1:TM=1325338577:LM=1332142444:GM=1:SG=2:S=rE0SyJh2w1IQ-Maw&quot;;
              sub_filter www.google.com $server_name;
              sub_filter_once off;
         }
     }
}
</code></pre><p>可能用到的命令：</p><pre><code>检查配置文件是否ok：/usr/local/nginx/nginx -t
已某配置文件开启nginx：/usr/local/nginx/nginx -c path/nginx.conf
</code></pre><p>Step9、虽说服务器稳定性较高，但也不是万能的。。。服务器宕机怎么办？每次都要人工去维护？</p><p>添加开机启动<code>vi /etc/init.d/nginx</code>，然后输入以下内容并保存：</p><pre><code>#!/bin/bash
#
# chkconfig: - 85 15
# description: Nginx is a World Wide Web server.
# processname: nginx

nginx=/usr/local/nginx/nginx
conf=/usr/local/nginx/nginx.conf
nginx_pid=/usr/local/nginx/nginx.pid
case $1 in
start)
echo -n &quot;Starting Nginx&quot;
$nginx -c $conf
echo &quot; done&quot;
;;
stop)
echo -n &quot;Stopping Nginx&quot;
kill -TERM `cat $nginx_pid`
echo &quot; done&quot;
;;
test)
$nginx -t -c $conf
;;
reload)
echo -n &quot;Reloading Nginx&quot;
ps auxww | grep nginx | grep master | awk '{print $2}' | xargs kill -HUP
echo &quot; done&quot;
;;
restart)
$0 stop
sleep 1
$0 start
;;
status)
ps -aux|grep nginx
;;
*)
echo -n &quot;Usage: $0 {start|restart|reload|stop|test|status}&quot;
;;
esac
</code></pre><p>更改权限<code>chmod 755 /etc/init.d/nginx</code>，添加到开机启动项<code>chkconfig nginx on</code></p><p>可能用到的命令</p><pre><code>查看开机启动项：chkconfig --list

启动服务：service nginx start
停止服务：service nginx stop
重启服务：service nginx restart
重新加载：service nginx reload
显示状态：service nginx show

上述命令也可以用 /etc/init.d/nginx command 替换

强暴的杀掉nginx：pkill -9 nginx
</code></pre><p>最后的最后，可能用到的命令：</p><pre><code>登录到远程主机：ssh [email protected] -p port
复制本地文件到vps：scp -P port /path/file [email protected]:/path
</code></pre><h4 id=引用参考>引用参考：</h4><blockquote><p>1、<a href=http://teddysun.com/342.html>http://teddysun.com/342.html</a></p><p>2、<a href=http://www.nginx.cn/install>http://www.nginx.cn/install</a></p><p>3、<a href=http://rmingwang.com/install-nginx-third-modules-http_sub_module.html>http://rmingwang.com/install-nginx-third-modules-http_sub_module.html</a></p><p>4、<a href=http://blog.linuxeye.com/399.html>http://blog.linuxeye.com/399.html</a></p></blockquote><h5><a href="https://www.digitalocean.com/?refcode=4351d40e44b2&utm_campaign=Referral_Invite&utm_medium=Referral_Program&utm_source=CopyPaste">最简单好用的 VPS,没有之一，注册立得 100 美金</a></h5></div><div class="col-lg-8 mx-auto block shadow"><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var t=document,e=t.createElement('script');e.async=!0,e.src='//pin-cong-jing-xuan.disqus.com/embed.js',e.setAttribute('data-timestamp',+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><div class="col-lg-8 mx-auto block shadow"><h3>See Also</h3><div class=container><div class=row><div class="mx-auto px-0"><div class="bg-white shadow block"></div></div></div></div></div></div></div></div></section><script>var i,images=document.getElementsByTagName("img");for(i=0;i<images.length;i++)images[i].className+="img-fluid w-100 mb-4"</script><footer class="py-4 bg-light border-top"><div class=container><div class="row justify-content-between align-items-center"><div class="col-lg-4 text-center text-lg-left mb-4 mb-lg-0"><a href=https://project-gutenberg.github.io/Pincong/><img src=https://project-gutenberg.github.io/Pincong//images/logo.png class=img-fluid alt=品葱*精选></a></div><div class="col-lg-4 text-center mb-4 mb-lg-0"><ul class="list-inline mb-0"></ul></div><div class="col-lg-4 text-lg-right text-center mb-4 mb-lg-0"><ul class="list-inline social-icon mb-0"><li class=list-inline-item><a href=https://pincong.rocks/><i class=ti-home></i></a></li><li class=list-inline-item><a href=https://github.com/Project-Gutenberg/Pincong><i class=ti-github></i></a></li></ul></div><div class="col-12 text-center mt-4"><span></span></div></div></div></footer><script src=../../plugins/jQuery/jquery.min.js></script>
<script src=../../plugins/bootstrap/bootstrap.min.js></script>
<script src=../../plugins/search/fuse.min.js></script>
<script src=../../plugins/search/mark.js></script>
<script src=../../plugins/search/search.js></script>
<script src=https://project-gutenberg.github.io/Pincong/js/script.min.js></script>
<script>(function(e,o,i,a,t,n,s){e.GoogleAnalyticsObject=t,e[t]=e[t]||function(){(e[t].q=e[t].q||[]).push(arguments)},e[t].l=1*new Date,n=o.createElement(i),s=o.getElementsByTagName(i)[0],n.async=1,n.src=a,s.parentNode.insertBefore(n,s)})(window,document,'script','//www.google-analytics.com/analytics.js','ga'),ga('create','UA-151212685-6','auto'),ga('send','pageview')</script></body></html>